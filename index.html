<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pack Test Tracker</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
      background-color: #eef2f3;
    }
    h1 { color: #333; }
    .stat { font-size: 1.3em; margin: 10px 0; }

    #goalInput, #stats { margin: 20px 0; }

    #distance-bar-container, #lap-bar-container {
      position: relative;
      height: 30px;
      margin: 20px auto;
      width: 90%;
      background-color: #ccc;
      border-radius: 15px;
      overflow: hidden;
    }

    #distance-bar-fill, #lap-bar-fill {
      height: 100%;
      background-color: teal;
      width: 0%;
      transition: width 0.5s;
    }

    #distance-label, #lap-label {
      position: absolute;
      width: 100%;
      text-align: center;
      top: 3px;
      font-size: 1.2em;
      color: white;
    }

    #pace-visual {
      position: relative;
      height: 60px;
      margin: 30px 0;
      background: linear-gradient(to right, #eef2f3 50%, #ccc 50%);
      border-top: 3px solid #444;
    }

    #goal-line {
      position: absolute;
      top: 0;
      left: 50%;
      width: 2px;
      height: 40px;
      background: red;
    }

    #progress-icon {
      position: absolute;
      top: -10px;
      width: 20px;
      height: 20px;
      background: teal;
      border-radius: 50%;
      border: 2px solid white;
    }

    #estimate-text {
      position: absolute;
      top: 42px;
      width: 100%;
      font-size: 1em;
      color: #333;
    }

    #map {
      height: 300px;
      margin: 20px 0;
      border: 2px solid #444;
      border-radius: 10px;
    }

    button {
      padding: 10px 20px;
      font-size: 1.2em;
      margin: 10px;
      background-color: teal;
      color: white;
      border: none;
      border-radius: 5px;
    }

    button:disabled { background-color: gray; }
  </style>
</head>
<body>
  <h1>Pack Test Tracker</h1>

  <div id="goalInput">
    <label for="goalTime">Enter goal time (min):</label>
    <input type="number" id="goalTime" value="45" min="1" style="width: 60px;">
  </div>

  <div id="stats">
    <div class="stat">Time: <span id="time">00:00</span></div>
    <div class="stat">Pace: <span id="pace">--</span> min/mi</div>
    <div class="stat">Laps: <span id="laps">0</span> / 12</div>
  </div>

  <div id="distance-bar-container">
    <div id="distance-bar-fill"></div>
    <div id="distance-label">0.00 / 3.00 miles</div>
  </div>

  <div id="lap-bar-container">
    <div id="lap-bar-fill"></div>
    <div id="lap-label">0 / 12 laps</div>
  </div>

  <div id="pace-visual">
    <div id="goal-line"></div>
    <div id="progress-icon"></div>
    <div id="estimate-text">Est. Finish: --:--</div>
  </div>

  <div id="map"></div>

  <button id="startBtn">Start Test</button>
  <button id="stopBtn" disabled>Stop Test</button>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let watchId, startTime, totalDistance = 0, lapCount = 0, lastPosition = null, timerInterval = null;
    let map, pathLine, goalTime = 45;
    const pathCoords = [];

    const timeEl = document.getElementById("time");
    const paceEl = document.getElementById("pace");
    const lapsEl = document.getElementById("laps");
    const goalInput = document.getElementById("goalTime");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");

    const distanceLabel = document.getElementById("distance-label");
    const distanceBarFill = document.getElementById("distance-bar-fill");
    const lapLabel = document.getElementById("lap-label");
    const lapBarFill = document.getElementById("lap-bar-fill");

    const progressIcon = document.getElementById("progress-icon");
    const estimateText = document.getElementById("estimate-text");

    function initMap(lat, lon) {
      map = L.map('map').setView([lat, lon], 17);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
      }).addTo(map);
      pathLine = L.polyline([], { color: 'blue' }).addTo(map);
    }

    startBtn.onclick = () => {
      goalTime = parseInt(goalInput.value) || 45;
      totalDistance = 0;
      lapCount = 0;
      lastPosition = null;
      pathCoords.length = 0;
      updateDistanceBar();
      updateLapBar();

      if (map) map.remove();
      document.getElementById('map').innerHTML = "";

      navigator.geolocation.getCurrentPosition(pos => {
        initMap(pos.coords.latitude, pos.coords.longitude);
      });

      startTime = Date.now();
      updateTime();
      timerInterval = setInterval(updateTime, 1000);

      watchId = navigator.geolocation.watchPosition(updatePosition, console.error, {
        enableHighAccuracy: true, timeout: 10000, maximumAge: 0
      });

      startBtn.disabled = true;
      stopBtn.disabled = false;
      goalInput.disabled = true;
    };

    stopBtn.onclick = () => {
      navigator.geolocation.clearWatch(watchId);
      clearInterval(timerInterval);
      startBtn.disabled = false;
      stopBtn.disabled = true;
      goalInput.disabled = false;
    };

    function updateTime() {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
      const secs = (elapsed % 60).toString().padStart(2, '0');
      timeEl.textContent = `${mins}:${secs}`;
    }

    function updatePosition(pos) {
      const { latitude, longitude } = pos.coords;
      const now = Date.now();

      if (lastPosition) {
        const d = getDistanceFromLatLonInMi(latitude, longitude, lastPosition.lat, lastPosition.lon);
        if (d > 0.0001) {
          totalDistance += d;
          lapCount = Math.min(12, Math.floor(totalDistance / 0.25));
          updateDistanceBar();
          updateLapBar();
        }
      }

      lastPosition = { lat: latitude, lon: longitude };
      lapsEl.textContent = lapCount;

      const elapsedMin = (now - startTime) / 60000;
      let pace = "--", est = "--:--";

      if (totalDistance > 0.01) {
        pace = (elapsedMin / totalDistance).toFixed(2);
        const estimate = 3 * (elapsedMin / totalDistance);
        const estM = Math.floor(estimate).toString().padStart(2, '0');
        const estS = Math.floor((estimate % 1) * 60).toString().padStart(2, '0');
        est = `${estM}:${estS}`;
        updatePaceVisual(estimate);
      } else {
        updatePaceVisual(0);
      }

      paceEl.textContent = pace;
      estimateText.textContent = "Est. Finish: " + est;

      if (map) {
        const latlng = [latitude, longitude];
        pathCoords.push(latlng);
        pathLine.setLatLngs(pathCoords);
        map.setView(latlng);
      }
    }

    function updateDistanceBar() {
      const percent = Math.min(100, (totalDistance / 3) * 100);
      distanceBarFill.style.width = percent + "%";
      distanceLabel.textContent = `${totalDistance.toFixed(2)} / 3.00 miles`;
    }

    function updateLapBar() {
      const percent = Math.min(100, (lapCount / 12) * 100);
      lapBarFill.style.width = percent + "%";
      lapLabel.textContent = `${lapCount} / 12 laps`;
    }

    function updatePaceVisual(estimate) {
      const percent = Math.max(0, Math.min(100, 50 + ((goalTime - estimate) / goalTime) * 50));
      progressIcon.style.left = `calc(${percent}% - 10px)`;
    }

    function getDistanceFromLatLonInMi(lat1, lon1, lat2, lon2) {
      const R = 3958.8;
      const dLat = deg2rad(lat2 - lat1);
      const dLon = deg2rad(lon2 - lon1);
      const a = Math.sin(dLat / 2) ** 2 + Math.cos(deg2rad(lat1)) *
                Math.cos(deg2rad(lat2)) * Math.sin(dLon / 2) ** 2;
      return R * (2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a)));
    }

    function deg2rad(deg) {
      return deg * (Math.PI / 180);
    }
  </script>
</body>
</html>
