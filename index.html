<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <title>Pack Test Tracker with Pace Guide</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <link rel="stylesheet" href="https://unpkg.com/leaflet/dist/leaflet.css" />
  <style>
    body {
      font-family: sans-serif;
      text-align: center;
      padding: 20px;
      background-color: #eef2f3;
    }
    h1 {
      color: #333;
    }
    #stats, #goalInput {
      margin: 20px 0;
    }
    .stat {
      font-size: 1.4em;
      margin: 10px 0;
    }
    #map {
      height: 300px;
      margin: 20px 0;
      border: 2px solid #444;
      border-radius: 10px;
    }
    #pace-visual {
      position: relative;
      height: 40px;
      margin: 30px 0;
      background: linear-gradient(to right, #ccc 50%, #eef2f3 50%);
      border-top: 3px solid #444;
    }
    #goal-line {
      position: absolute;
      top: 0;
      left: 50%;
      width: 2px;
      height: 40px;
      background: red;
    }
    #progress-icon {
      position: absolute;
      top: -10px;
      width: 20px;
      height: 20px;
      background: teal;
      border-radius: 50%;
      border: 2px solid white;
    }
    button {
      padding: 10px 20px;
      font-size: 1.2em;
      margin: 10px;
      background-color: teal;
      color: white;
      border: none;
      border-radius: 5px;
    }
    button:disabled {
      background-color: gray;
    }
  </style>
</head>
<body>
  <h1>Pack Test Tracker</h1>

  <div id="goalInput">
    <label for="goalTime">Enter goal finish time (minutes):</label>
    <input type="number" id="goalTime" value="45" min="1" style="width: 60px;">
  </div>

  <div id="stats">
    <div class="stat">Distance: <span id="distance">0.00</span> mi</div>
    <div class="stat">Time: <span id="time">00:00</span></div>
    <div class="stat">Pace: <span id="pace">--</span> min/mi</div>
    <div class="stat">Est. Finish: <span id="estimate">--:--</span></div>
    <div class="stat">Laps (0.25 mi): <span id="laps">0</span></div>
  </div>

  <div id="pace-visual">
    <div id="goal-line"></div>
    <div id="progress-icon"></div>
  </div>

  <div id="map"></div>

  <button id="startBtn">Start Test</button>
  <button id="stopBtn" disabled>Stop Test</button>

  <script src="https://unpkg.com/leaflet/dist/leaflet.js"></script>
  <script>
    let watchId, startTime, totalDistance = 0, lapCount = 0, lastPosition = null, timerInterval = null;
    let map, pathLine, goalTime = 45;
    const pathCoords = [];

    const distanceEl = document.getElementById("distance");
    const timeEl = document.getElementById("time");
    const paceEl = document.getElementById("pace");
    const estimateEl = document.getElementById("estimate");
    const lapsEl = document.getElementById("laps");
    const startBtn = document.getElementById("startBtn");
    const stopBtn = document.getElementById("stopBtn");
    const goalInput = document.getElementById("goalTime");
    const progressIcon = document.getElementById("progress-icon");

    function initMap(lat, lon) {
      map = L.map('map').setView([lat, lon], 17);
      L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        maxZoom: 19
      }).addTo(map);
      pathLine = L.polyline([], { color: 'blue' }).addTo(map);
    }

    startBtn.onclick = () => {
      goalTime = parseInt(goalInput.value) || 45;

      if (!navigator.geolocation) {
        alert("Geolocation not supported.");
        return;
      }

      startTime = Date.now();
      totalDistance = 0;
      lapCount = 0;
      lastPosition = null;
      pathCoords.length = 0;
      if (map) map.remove();
      document.getElementById('map').innerHTML = "";

      navigator.geolocation.getCurrentPosition(pos => {
        const { latitude, longitude } = pos.coords;
        initMap(latitude, longitude);
      });

      updateTime();
      timerInterval = setInterval(updateTime, 1000);
      watchId = navigator.geolocation.watchPosition(updatePosition, console.error, {
        enableHighAccuracy: true, timeout: 10000, maximumAge: 0
      });

      startBtn.disabled = true;
      stopBtn.disabled = false;
      goalInput.disabled = true;
    };

    stopBtn.onclick = () => {
      navigator.geolocation.clearWatch(watchId);
      clearInterval(timerInterval);
      startBtn.disabled = false;
      stopBtn.disabled = true;
      goalInput.disabled = false;
    };

    function updateTime() {
      const elapsed = Math.floor((Date.now() - startTime) / 1000);
      const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
      const secs = (elapsed % 60).toString().padStart(2, '0');
      timeEl.textContent = `${mins}:${secs}`;
    }

    function updatePosition(pos) {
      const { latitude, longitude } = pos.coords;
      const currentTime = Date.now();

      if (lastPosition) {
        const d = getDistanceFromLatLonInMi(latitude, longitude, lastPosition.lat, lastPosition.lon);
        if (d > 0.0001) {
          totalDistance += d;
          if (totalDistance >= (lapCount + 1) * 0.25) lapCount++;
        }
      }

      lastPosition = { lat: latitude, lon: longitude };
      distanceEl.textContent = totalDistance.toFixed(2);
      lapsEl.textContent = lapCount;

      const elapsed = (currentTime - startTime) / 1000 / 60;
      if (totalDistance >= 0.05) {
        const pace = (elapsed / totalDistance).toFixed(2);
        paceEl.textContent = pace;

        const estimate = 3 * (elapsed / totalDistance);
        const estMins = Math.floor(estimate).toString().padStart(2, '0');
        const estSecs = Math.floor((estimate % 1) * 60).toString().padStart(2, '0');
        estimateEl.textContent = `${estMins}:${estSecs}`;

        updatePaceVisual(estimate);
      } else {
        paceEl.textContent = "--";
        estimateEl.textContent = "--:--";
        updatePaceVisual(0);
      }

      if (map) {
        const latlng = [latitude, longitude];
        pathCoords.push(latlng);
        pathLine.setLatLngs(pathCoords);
        map.setView(latlng);
      }
    }

    function updatePaceVisual(currentEstimate) {
      const icon = document.getElementById("progress-icon");
      const percent = Math.max(0, Math.min(100, 50 + ((currentEstimate - goalTime) / goalTime) * 50));
      icon.style.left = `calc(${percent}% - 10px)`;
    }

    function getDistanceFromLatLonInMi(lat1, lon1, lat2, lon2) {
      const R = 3958.8;
      const dLat = deg2rad(lat2 - lat1);
      const dLon = deg2rad(lon2 - lon1);
      const a = Math.sin(dLat / 2) * Math.sin(dLat / 2) +
                Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
                Math.sin(dLon / 2) * Math.sin(dLon / 2);
      const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
      return R * c;
    }

    function deg2rad(deg) {
      return deg * (Math.PI / 180);
    }
  </script>
</body>
</html>
