<script>
  let watchId;
  let startTime;
  let totalDistance = 0;
  let lastPosition = null;
  let timerInterval = null;

  const distanceEl = document.getElementById("distance");
  const timeEl = document.getElementById("time");
  const paceEl = document.getElementById("pace");
  const estimateEl = document.getElementById("estimate");
  const startBtn = document.getElementById("startBtn");
  const stopBtn = document.getElementById("stopBtn");

  startBtn.onclick = () => {
    console.log("✅ Start button clicked.");
    if (!navigator.geolocation) {
      alert("Geolocation not supported by your browser.");
      return;
    }

    startTime = Date.now();
    totalDistance = 0;
    lastPosition = null;

    updateTime(); // Show 00:00
    timerInterval = setInterval(updateTime, 1000); // Now continuously update

    watchId = navigator.geolocation.watchPosition(
      updatePosition,
      (err) => {
        console.error("❌ GPS Error:", err);
        alert("Location access denied or error: " + err.message);
      },
      { enableHighAccuracy: true, timeout: 10000, maximumAge: 0 }
    );

    startBtn.disabled = true;
    stopBtn.disabled = false;
  };

  stopBtn.onclick = () => {
    console.log("🛑 Stop button clicked.");
    navigator.geolocation.clearWatch(watchId);
    clearInterval(timerInterval); // stop timer
    startBtn.disabled = false;
    stopBtn.disabled = true;
  };

  function updateTime() {
    const elapsed = Math.floor((Date.now() - startTime) / 1000);
    const mins = Math.floor(elapsed / 60).toString().padStart(2, '0');
    const secs = (elapsed % 60).toString().padStart(2, '0');
    timeEl.textContent = `${mins}:${secs}`;
  }

  function updatePosition(pos) {
    const { latitude, longitude } = pos.coords;
    const currentTime = Date.now();

    console.log(`📍 GPS: ${latitude}, ${longitude}`);

    if (lastPosition) {
      const d = getDistanceFromLatLonInMi(latitude, longitude, lastPosition.lat, lastPosition.lon);
      if (d > 0.0001) { // ignore jitter
        totalDistance += d;
      }
    }

    lastPosition = { lat: latitude, lon: longitude };
    distanceEl.textContent = totalDistance.toFixed(2);

    const elapsed = (currentTime - startTime) / 1000 / 60;
    if (totalDistance >= 0.05) {
      const pace = (elapsed / totalDistance).toFixed(2);
      paceEl.textContent = pace;

      const estimate = 3 * (elapsed / totalDistance);
      const estMins = Math.floor(estimate).toString().padStart(2, '0');
      const estSecs = Math.floor((estimate % 1) * 60).toString().padStart(2, '0');
      estimateEl.textContent = `${estMins}:${estSecs}`;
    } else {
      paceEl.textContent = "--";
      estimateEl.textContent = "--:--";
    }
  }

  function getDistanceFromLatLonInMi(lat1, lon1, lat2, lon2) {
    const R = 3958.8;
    const dLat = deg2rad(lat2 - lat1);
    const dLon = deg2rad(lon2 - lon1);
    const a =
      Math.sin(dLat / 2) * Math.sin(dLat / 2) +
      Math.cos(deg2rad(lat1)) * Math.cos(deg2rad(lat2)) *
      Math.sin(dLon / 2) * Math.sin(dLon / 2);
    const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));
    return R * c;
  }

  function deg2rad(deg) {
    return deg * (Math.PI / 180);
  }
</script>
